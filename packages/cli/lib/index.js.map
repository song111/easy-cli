{"version":3,"sources":["../src/index.js"],"names":["Cli","constructor","cwd","argv","plugins","init","start","commands","subprocess","root","env","getEnv","pkg","resolvePackages","forEach","plugin","use","version","fork","path","options","execArgv","process","debugPort","on","index","findIndex","item","splice","push","exit","code","subPIds","map","subp","pid","force","tree","Object","keys","reduce","key","resolve","fs","existsSync","require","err","logger","error","register","cmd","desc","args","name","split","test","Error","chalk","redBright","yargs","command","parse","length","showHelp"],"mappings":"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","sourcesContent":["import path from 'path';\r\nimport fs from 'fs';\r\nimport yargs from 'yargs';\r\nimport fkill from 'fkill';\r\nimport { fork } from 'child_process';\r\nimport { logger, findRoot, chalk } from '@chrissong/cli-utils';\r\nimport init from './init';\r\nimport start from './start';\r\n\r\nexport default class Cli {\r\n  constructor (cwd, argv = []) {\r\n    this.cwd = cwd;\r\n    this.argv = argv;\r\n    this.plugins = [init, start];\r\n    this.commands = {}; // 命令集合\r\n    this.subprocess = []; // 子进程\r\n    this.init();\r\n  }\r\n\r\n  // 初始化\r\n  init () {\r\n    this.root = findRoot(this.cwd);\r\n    this.env = this.getEnv();\r\n    this.pkg = this.resolvePackages();\r\n    this.plugins.forEach((plugin) => this.use(plugin));\r\n  }\r\n\r\n  /**\r\n   * 版本信息\r\n   */\r\n\r\n  get version () {\r\n    return this.pkg.version;\r\n  }\r\n\r\n  /**\r\n   * 子进程执行脚本\r\n   * @param {String} path\r\n   * @param  {String[]} argv\r\n   * @param  {Object} options\r\n   */\r\n  fork (path, argv, options) {\r\n    const subprocess = fork(path, argv, {\r\n      env: this.env, // 子进程继承当前环境的环境变量\r\n      execArgv: [`--inspect-brk=127.0.0.1:${process.debugPort + 1}`], // 开发模式\r\n      ...options\r\n    });\r\n\r\n    subprocess.on('close', () => {\r\n      const index = this.subprocess.findIndex((item) => item === subprocess);\r\n      this.subprocess.splice(index, 1);\r\n    });\r\n\r\n    this.subprocess.push(subprocess);\r\n    return subprocess;\r\n  }\r\n\r\n  /**\r\n   * 退出进程\r\n   * @param {Number} code\r\n   **/\r\n  async exit (code) {\r\n    const subPIds = this.subprocess.map((subp) => subp.pid);\r\n    await fkill(subPIds, { force: true, tree: true });\r\n    process.exit(code);\r\n  }\r\n\r\n  /**\r\n   * 获取当前环境的环境变量\r\n   */\r\n  getEnv () {\r\n    return Object.keys(process.env).reduce((env, key) => {\r\n      env[key] = process.env[key];\r\n      return env;\r\n    }, {});\r\n  }\r\n\r\n  /**\r\n   * 使用插件 注入cli 实例\r\n   * @param {Function} plugin\r\n   */\r\n\r\n  use (plugin) {\r\n    plugin(this);\r\n  }\r\n\r\n  /**\r\n   * 获取package.json信息\r\n   */\r\n  resolvePackages () {\r\n    const pkg = path.resolve(this.root, 'package.json');\r\n    if (!fs.existsSync(pkg)) return {};\r\n    try {\r\n      return require(pkg);\r\n    } catch (err) {\r\n      logger.error(`读取${pkg}失败！`);\r\n      return {};\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 注册命令\r\n   * @param {String} cmd\r\n   * @param {String} desc\r\n   * @param  {...any} args\r\n   */\r\n  register (cmd, desc, ...args) {\r\n    const name = cmd.split(/\\s+/)[0];\r\n\r\n    if (!/^[\\w:]+$/.test(name)) {\r\n      // 只能有数字、字母、下划线、冒号组成\r\n      throw new Error(`命令名称 ${chalk.redBright(name)} 不合法，只能是字母、数字、下划线、冒号`);\r\n    }\r\n\r\n    if (!desc) throw new Error('命令描述 desc 不存在');\r\n    if (this.commands[name]) throw new Error(`命令 ${chalk.redBright(name)} 已经被占用`);\r\n    this.commands[name] = { cmd, desc, ...args };\r\n    yargs.command(cmd, desc, ...args);\r\n  }\r\n\r\n  /**\r\n   * 解析命令行参数\r\n   * @param {Array} argv\r\n   */\r\n  parse (argv) {\r\n    this.argv = argv;\r\n    if (this.argv.length) {\r\n      yargs.parse(this.argv);\r\n    } else {\r\n      yargs.showHelp();\r\n    }\r\n  }\r\n}\r\n"],"file":"index.js"}