{"version":3,"sources":["../../src/init/install.js"],"names":["pkgManager","targetDir","args","cmd","join","logger","log","chalk","cyan","Promise","resolve","reject","child","cwd","stdio","stderr","on","buf","str","toString","test","progressBarMatch","match","renderProgressBar","process","write","code","curr","total","ratio","Math","min","max","bar","availableSpace","columns","length","width","completeLength","round","complete","repeat","incomplete","toStartOfLine","stream","supportsColor","readline","cursorTo"],"mappings":"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","sourcesContent":["import { logger, chalk, execa } from '@chrissong/cli-utils';\r\nimport readline from 'readline';\r\n\r\n/**\r\n * 安装依赖\r\n * @param{string} pkgManager yarn|npm\r\n * @param{string} targetDir  项目路径\r\n */\r\nexport default async (pkgManager, targetDir) => {\r\n  const args = pkgManager === 'npm' ? ['install', '--loglevel', 'error'] : ['install'];\r\n  debugger;\r\n  const cmd = `${pkgManager} ${args.join(' ')}`;\r\n  logger.log(`🚀  安装项目依赖 ${chalk.cyan(cmd)}，请稍等...`);\r\n\r\n  debugger;\r\n  return new Promise((resolve, reject) => {\r\n    const child = execa(pkgManager, args, {\r\n      cwd: targetDir,\r\n      stdio: ['inherit', 'inherit', 'pipe']\r\n    });\r\n    if (pkgManager === 'yarn') {\r\n      child.stderr.on('data', (buf) => {\r\n        const str = buf.toString();\r\n\r\n        if (/warning/.test(str)) return;\r\n\r\n        const progressBarMatch = str.match(/\\[.*\\] (\\d+)\\/(\\d+)/);\r\n        if (progressBarMatch) {\r\n          // since yarn is in a child process, it's unable to get the width of\r\n          // the terminal. reimplement the progress bar ourselves!\r\n          renderProgressBar(progressBarMatch[1], progressBarMatch[2]);\r\n          return;\r\n        }\r\n\r\n        process.stderr.write(buf);\r\n      });\r\n    }\r\n\r\n    child.on('close', (code) => {\r\n      if (code !== 0) {\r\n        reject(`pkgManager failed: ${pkgManager} ${args.join(' ')}`);\r\n        return;\r\n      }\r\n      resolve();\r\n    });\r\n  });\r\n};\r\n\r\n// 进度读取来自于 vue-cli\r\nfunction renderProgressBar(curr, total) {\r\n  const ratio = Math.min(Math.max(curr / total, 0), 1);\r\n  const bar = ` ${curr}/${total}`;\r\n  const availableSpace = Math.max(0, process.stderr.columns - bar.length - 3);\r\n  const width = Math.min(total, availableSpace);\r\n  const completeLength = Math.round(width * ratio);\r\n  const complete = `#`.repeat(completeLength);\r\n  const incomplete = `-`.repeat(width - completeLength);\r\n  toStartOfLine(process.stderr);\r\n  process.stderr.write(`[${complete}${incomplete}]${bar}`);\r\n}\r\n\r\nfunction toStartOfLine(stream) {\r\n  if (!chalk.supportsColor) {\r\n    stream.write('\\r');\r\n    return;\r\n  }\r\n  readline.cursorTo(stream, 0);\r\n}\r\n"],"file":"install.js"}